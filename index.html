<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tracklist with Interactive Waveform Audio Player</title>
  <style>
    /*
      === Modern Browser CSS Reset (Eric Meyer v2.0 adapted) ===
      Ensures consistent styling across browsers by neutralizing default styles.
      Source: [https://meyerweb.com/eric/tools/css/reset/](https://meyerweb.com/eric/tools/css/reset/)
    */
    html, body, div, span, applet, object, iframe,
    h1, h2, h3, h4, h5, h6, p, blockquote, pre,
    a, abbr, acronym, address, big, cite, code,
    del, dfn, em, img, ins, kbd, q, s, samp,
    small, strike, strong, sub, sup, tt, var,
    b, u, i, center,
    dl, dt, dd, ol, ul, li,
    fieldset, form, label, legend,
    table, caption, tbody, tfoot, thead, tr, th, td,
    article, aside, canvas, details, embed,
    figure, figcaption, footer, header, hgroup,
    menu, nav, output, ruby, section, summary,
    time, mark, audio, video {
      margin: 0;
      padding: 0;
      border: 0;
      font-size: 100%;
      font: inherit;
      vertical-align: baseline;
      outline: 0;
    }
    /* HTML5 display-role reset for older browsers */
    article, aside, details, figcaption, figure,
    footer, header, hgroup, menu, nav, section {
      display: block;
    }
    body {
      line-height: 1;
      background: var(--background);
      color: var(--text-color-bright);
      font-family: Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    ol, ul {
      list-style: none;
    }
    blockquote, q {
      quotes: none;
    }
    blockquote:before, blockquote:after,
    q:before, q:after {
      content: '';
      content: none;
    }
    table {
      border-collapse: collapse;
      border-spacing: 0;
    }
    /* Mobile-first default: content elements width 460px */
    .content {
      width: 460px;
      margin: 0 auto 32px auto;
      box-sizing: border-box;
      user-select: none;
      display: flex;
      flex-direction: column;
      justify-content: center; /* vertically center the content */
    }
    /* Playlist container is full width and uses flex column */
    #playlist-container {
      width: 100%;
      box-sizing: border-box;
      user-select: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 32px;
      padding-bottom: 80px; /* for footer */
    }
    /* Track item is the .content wrapper for each */
    .track-item.content {
      display: flex;
      flex-direction: column;
      width: 460px;
      box-sizing: border-box;
      justify-content: center; /* vertically center track item */
    }
    /* 1st container: cover art full width */
    .track-cover-container {
      width: 100%;
      margin-bottom: 8px;
    }
    .track-cover-container img {
      width: 100%;
      height: auto;
      border-radius: 8px;
      display: block;
      user-select: none;
      pointer-events: none;
    }
    /* 2nd container: flex row for three subcontainers */
    .track-info-container {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      box-sizing: border-box;
      margin-bottom: 8px;
      position: relative;
    }
    /* 1st subcontainer: play button no left margin/padding */
    .play-btn-container {
      flex: 0 0 auto;
      margin: 0;
      padding: 0;
    }
    .btn-play-pause {
      background: var(--button-bg);
      color: var(--button-color);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
      width: 38px;
      height: 38px;
      padding: 0;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1rem;
    }
    .btn-play-pause:hover {
      background: var(--button-hover-bg);
    }
    /* 2nd subcontainer: artist and title stacked */
    .artist-title-container {
      flex: 1 1 auto;
      margin-left: 8px;
      margin-right: 8px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      overflow: hidden;
      min-width: 0;
      user-select: none;
    }
    .track-artist {
      font-weight: 400;
      font-size: 16px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 2px;
      color: var(--text-color);
    }
    .track-title {
      font-weight: 700;
      font-size: 18px;
      line-height: 1.1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text-color-bright);
    }
    /* 3rd subcontainer: genre/date top row, play-pos/duration bottom row */
    .meta-info-container {
      flex: 0 0 auto;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: flex-end;
      user-select: none;
      max-height: 100%;
      box-sizing: border-box;
    }
    .genre-date-row {
      display: flex;
      gap: 12px;
      white-space: nowrap;
      font-weight: 300;
      font-size: 0.9rem;
      color: var(--text-color);
    }
    .time-row {
      font-family: monospace;
      letter-spacing: 0.04em;
      min-width: 138px;
      justify-content: flex-end;
      color: var(--text-color);
      font-weight: 300;
      font-size: 0.9rem;
      margin-top: auto;
      display: flex;
      gap: 6px;
      white-space: nowrap;
      align-items: center;
    }
    .time-row .separator {
      user-select: none;
    }
    /* 3rd container: waveform full width */
    .waveform-container {
      width: 100%;
      margin-bottom: 8px;
      user-select: none;
      border-radius: 8px;
      overflow: hidden;
    }
    canvas.waveform-canvas {
      width: 100%;
      height: 110px;
      display: block;
      cursor: pointer;
      border-radius: 8px;
      background: transparent;
    }
    /* 4th container: toggle and content full width */
    .tracklist-container {
      width: 100%;
      margin-top: 0;
      user-select: none;
    }
    .btn-toggle-tracklist {
      background: transparent;
      border: none;
      cursor: pointer;
      color: var(--text-color);
      font-weight: 300;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 6px;
      user-select: none;
      width: 100%;
      justify-content: center;
      padding: 0;
    }
    .btn-toggle-tracklist::after {
      content: 'â–¼';
      font-size: 0.6rem;
      transition: transform 0.3s ease;
    }
    .btn-toggle-tracklist[aria-expanded="true"]::after {
      transform: rotate(-180deg);
    }
    .tracklist-content {
      display: none;
      margin-top: 8px;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 150px;
      overflow-y: auto;
      color: var(--text-color);
      width: 100%;
    }
    .tracklist-content.visible {
      display: block;
    }
    /* THEME VARIABLES */
    :root {
      --button-bg: #383351;
      --button-color: #fff;
      --button-hover-bg: #4f4a85;
      --text-color: #555;
      --text-color-bright: #222;
      --footer-bg: #eee;
      --waveform-active: #383351;
      --waveform-inactive: var(--text-color);
      --waveform-hover: #fff100;
      --background: #fff;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --button-bg: #a3a3e3;
        --button-color: #222;
        --button-hover-bg: #8a8aea;
        --text-color: #ccc;
        --text-color-bright: #f0f0f0;
        --footer-bg: #222;
        --waveform-active: #a3a3e3;
        --waveform-inactive: var(--text-color);
        --waveform-hover: #ffff70;
        --background: #121212;
      }
      body {
        background: var(--background);
      }
    }
    /* Footer containing new inner container */
    #footer-controls {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 60px;
      background-color: var(--footer-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
      user-select: none;
      z-index: 1000;
      padding: 0 20px;
    }
    #footer-controls .footer-inner-container {
      width: 460px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }
    #footer-controls .btn-play-pause {
      padding: 0;
      font-size: 1.1rem;
      min-width: 38px;
      cursor: pointer;
      background: var(--button-bg);
      border: none;
      border-radius: 4px;
      color: var(--button-color);
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 38px;
      height: 38px;
    }
    #footer-controls .btn-play-pause:hover {
      background: var(--button-hover-bg);
    }
    /* Volume control with updated colors and height */
    #footer-controls input[type=range] {
      width: 120px;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      background-color: var(--background);
      height: 20px;
      border-radius: 5px;
      position: relative;
      overflow: hidden;
      --vol-percent: 100%;
    }
    #footer-controls input[type=range]::-webkit-slider-runnable-track {
      height: 20px;
      background: linear-gradient(to right, var(--button-bg) 0%, var(--button-bg) var(--vol-percent), var(--background) var(--vol-percent), var(--background) 100%);
      border-radius: 5px;
    }
    #footer-controls input[type=range]::-moz-range-track {
      height: 20px;
      background: linear-gradient(to right, var(--button-bg) 0%, var(--button-bg) var(--vol-percent), var(--background) var(--vol-percent), var(--background) 100%);
      border-radius: 5px;
      border: none;
    }
    /* Hide the thumb/knob */
    #footer-controls input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 0;
      height: 0;
      margin-top: 0;
      border: none;
      background: transparent;
      cursor: pointer;
    }
    #footer-controls input[type=range]::-moz-range-thumb {
      width: 0;
      height: 0;
      border: none;
      background: transparent;
      cursor: pointer;
    }
    svg.play-icon, svg.pause-icon {
      width: 20px;
      height: 20px;
      fill: currentColor;
      display: block;
    }
  </style>
</head>
<body>
<div id="playlist-container" aria-label="Artist profile tracklist"></div>
<div id="footer-controls" aria-label="Global audio controls">
  <div class="footer-inner-container">
    <button class="btn-play-pause" aria-label="Play/Pause global audio player" title="Play/Pause global audio player"></button>
    <input type="range" min="0" max="1" step="0.01" value="1" aria-label="Volume control" />
  </div>
</div>
<script src="music.js"></script>
<script>
  // SVG icons for play and pause
  const playSVG = `<svg class="play-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><polygon points="6 4 20 12 6 20" /></svg>`;
  const pauseSVG = `<svg class="pause-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>`;

  /* ==== Global state ==== */
  const tracks = [];
  let playingIndex = -1;
  // Footer controls references
  const footerPlayBtn = document.querySelector('#footer-controls .btn-play-pause');
  const footerVolumeInput = document.querySelector('#footer-controls input[type="range"]');
  /** Time formatting for mm:ss */
  function formatTime(s) {
    if(!s) return '0:00';
    const m = Math.floor(s / 60);
    const ss = Math.floor(s % 60);
    return `${m}:${ss < 10 ? '0' : ''}${ss}`;
  }
  /** Draw waveform canvas with 1px spacing, highlight hover */
  function drawWaveform(ctx, ampData, progress, width, height, hoverIndex = -1, isHovering = false) {
    ctx.clearRect(0, 0, width, height);
    const midY = height / 2;
    const total = ampData.length;
    const barWidth = width / (total * 2);
    const spaceWidth = barWidth;
    for(let i = 0; i < total; i++) {
      const amp = ampData[i];
      const barHeight = amp * height;
      const x = i * (barWidth + spaceWidth);
      let fillStyle;
      if(isHovering && i === hoverIndex) {
        fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--waveform-hover');
      } else if(i / total <= progress) {
        fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--waveform-active');
      } else {
        fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--waveform-inactive');
      }
      ctx.fillStyle = fillStyle.trim();
      ctx.fillRect(x, midY - barHeight / 2, barWidth, barHeight);
    }
  }
  /**
   * Create track item with 4 containers per new spec,
   * and manage playback and interactions.
   */
  function createTrackElement(data, idx) {
    const trackElem = document.createElement('div');
    trackElem.className = 'track-item content';
    // 1st container: cover art
    const coverContainer = document.createElement('div');
    coverContainer.className = 'track-cover-container';
    const coverImg = document.createElement('img');
    coverImg.alt = `${data[2]} cover art`;
    coverImg.className = 'track-cover';
    coverImg.src = `data:image/png;base64,${data[7]}`;
    coverContainer.appendChild(coverImg);
    // 2nd container: split into 3 subcontainers
    const infoContainer = document.createElement('div');
    infoContainer.className = 'track-info-container';
    // 2.1 play button container (no left margin/padding)
    const playBtnContainer = document.createElement('div');
    playBtnContainer.className = 'play-btn-container';
    const playPauseBtn = document.createElement('button');
    playPauseBtn.className = 'btn-play-pause';
    playPauseBtn.setAttribute('aria-label', `Play or Pause ${data[2]} by ${data[1]}`);
    playBtnContainer.appendChild(playPauseBtn);
    // Initialize with play SVG
    playPauseBtn.innerHTML = playSVG;
    // 2.2 artist/title container stacked
    const artistTitleContainer = document.createElement('div');
    artistTitleContainer.className = 'artist-title-container';
    const artistDiv = document.createElement('div');
    artistDiv.className = 'track-artist';
    artistDiv.textContent = data[1];
    const titleDiv = document.createElement('div');
    titleDiv.className = 'track-title';
    titleDiv.textContent = data[2];
    artistTitleContainer.appendChild(artistDiv);
    artistTitleContainer.appendChild(titleDiv);
    // 2.3 meta container genre/date first row, time second row
    const metaContainer = document.createElement('div');
    metaContainer.className = 'meta-info-container';
    const genreDateRow = document.createElement('div');
    genreDateRow.className = 'genre-date-row';
    const genreDiv = document.createElement('div');
    genreDiv.className = 'track-genre';
    genreDiv.textContent = data[4];
    const dateDiv = document.createElement('div');
    dateDiv.className = 'track-date';
    dateDiv.textContent = data[3];
    genreDateRow.appendChild(genreDiv);
    genreDateRow.appendChild(dateDiv);
    const timeRow = document.createElement('div');
    timeRow.className = 'time-row';
    // Add play position and duration with separator "|"
    const playPosDiv = document.createElement('div');
    playPosDiv.className = 'play-pos';
    playPosDiv.textContent = '0:00';
    const sepDiv = document.createElement('div');
    sepDiv.className = 'separator';
    sepDiv.textContent = '|';
    const durDiv = document.createElement('div');
    durDiv.className = 'duration';
    durDiv.textContent = formatTime(data[5]);
    timeRow.appendChild(playPosDiv);
    timeRow.appendChild(sepDiv);
    timeRow.appendChild(durDiv);
    metaContainer.appendChild(genreDateRow);
    metaContainer.appendChild(timeRow);
    infoContainer.appendChild(playBtnContainer);
    infoContainer.appendChild(artistTitleContainer);
    infoContainer.appendChild(metaContainer);
    // 3rd container: waveform
    const waveformContainer = document.createElement('div');
    waveformContainer.className = 'waveform-container';
    const waveformCanvas = document.createElement('canvas');
    waveformCanvas.className = 'waveform-canvas';
    waveformCanvas.width = 600;
    waveformCanvas.height = 110;
    waveformContainer.appendChild(waveformCanvas);
    // 4th container: tracklist toggle & content
    const tracklistContainer = document.createElement('div');
    tracklistContainer.className = 'tracklist-container';
    let toggleBtn = null;
    let tracklistContent = null;
    if(data[6].trim() !== '') {
      toggleBtn = document.createElement('button');
      toggleBtn.className = 'btn-toggle-tracklist';
      toggleBtn.setAttribute('aria-expanded', 'false');
      // Remove â–¼ and â–² from text but keep CSS for arrow
      toggleBtn.textContent = 'Show Tracklist';
      toggleBtn.addEventListener('click', () => {
        const expanded = toggleBtn.getAttribute('aria-expanded') === 'true';
        toggleBtn.setAttribute('aria-expanded', expanded ? 'false' : 'true');
        tracklistContent.classList.toggle('visible');
        toggleBtn.textContent = 'Show Tracklist';
      });
      tracklistContent = document.createElement('pre');
      tracklistContent.className = 'tracklist-content';
      tracklistContent.textContent = data[6];
      tracklistContainer.appendChild(toggleBtn);
      tracklistContainer.appendChild(tracklistContent);
    }
    // Append all 4 containers to track item
    trackElem.appendChild(coverContainer);
    trackElem.appendChild(infoContainer);
    trackElem.appendChild(waveformContainer);
    if(tracklistContainer.childNodes.length) {
      trackElem.appendChild(tracklistContainer);
    }
    // Initialize audio element and playback state (fallback only)
    let audioElement = null;
    const ampData = JSON.parse(data[8]);
    const ctx = waveformCanvas.getContext('2d');
    const width = waveformCanvas.width;
    const height = waveformCanvas.height;
    let mouseHovering = false;
    let hoverIndex = -1;
    const duration = data[5];

    // Fallback audio setup (HTML5 audio element)
    audioElement = document.createElement('audio');
    audioElement.src = `music/${data[0]}`;
    audioElement.preload = 'metadata';
    audioElement.style.display = 'none';
    audioElement.controls = false;
    trackElem.appendChild(audioElement);

    // Draw initial waveform (starting at 0)
    drawWaveform(ctx, ampData, 0, width, height);

    // Variables for time update
    audioElement.addEventListener('timeupdate', () => {
      if(!mouseHovering) {
        const current = audioElement.currentTime;
        const dur = audioElement.duration || duration;
        const prog = dur ? current / dur : 0;
        drawWaveform(ctx, ampData, prog, width, height);
        timeRow.querySelector('.play-pos').textContent = formatTime(current);
        timeRow.querySelector('.duration').textContent = formatTime(dur);
        if(playingIndex === idx) updateFooterTime(current);
      }
    });
    audioElement.addEventListener('ended', () => {
      playPauseBtn.innerHTML = playSVG;
      if(playingIndex === idx) {
        playingIndex = -1;
        updateFooter(null, null, -1);
        playNextTrack(idx);
      }
    });

    /* Play/Pause button logic */
    playPauseBtn.addEventListener('click', () => {
      if(audioElement.paused) {
        // Pause others
        tracks.forEach(({audio, btnPlay}, i) => {
          if(i !== idx) {
            if(audio) audio.pause();
            btnPlay.innerHTML = playSVG;
          }
        });
        audioElement.play();
        playPauseBtn.innerHTML = pauseSVG;
        playingIndex = idx;
        updateFooter(audioElement, playPauseBtn, idx);
      } else {
        audioElement.pause();
        playPauseBtn.innerHTML = playSVG;
        if(playingIndex === idx) playingIndex = -1;
        updateFooter(null, null, -1);
      }
    });
    /* Waveform click seek */
    waveformCanvas.addEventListener('click', e => {
      const rect = waveformCanvas.getBoundingClientRect();
      const ratio = (e.clientX - rect.left) / rect.width;
      const dur = audioElement ? audioElement.duration || duration : duration;
      if(audioElement) {
        audioElement.currentTime = ratio * dur;
        drawWaveform(ctx, ampData, ratio, width, height);
      }
    });
    /* Hover effect: timestamp & peak highlight */
    waveformCanvas.addEventListener('mousemove', e => {
      mouseHovering = true;
      const rect = waveformCanvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const ratio = x / rect.width;
      hoverIndex = Math.min(Math.max(Math.floor(ratio * ampData.length), 0), ampData.length - 1);
      const dur = audioElement ? audioElement.duration || duration : duration;
      timeRow.querySelector('.play-pos').textContent = formatTime(ratio * dur);
      timeRow.querySelector('.duration').textContent = formatTime(dur);
      const prog = audioElement ? (audioElement.currentTime / dur) : 0;
      drawWaveform(ctx, ampData, prog, width, height, hoverIndex, true);
    });
    waveformCanvas.addEventListener('mouseleave', () => {
      mouseHovering = false;
      hoverIndex = -1;
      const dur = audioElement ? audioElement.duration || duration : duration;
      const curTime = audioElement ? audioElement.currentTime : 0;
      const prog = dur ? curTime / dur : 0;
      drawWaveform(ctx, ampData, prog, width, height);
      timeRow.querySelector('.play-pos').textContent = formatTime(curTime);
      timeRow.querySelector('.duration').textContent = formatTime(dur);
    });

    return {
      container: trackElem,
      audio: audioElement,
      btnPlay: playPauseBtn,
      timeDisplay: timeRow,
      canvasCtx: ctx,
      ampData,
      width,
      height,
      isWebAudio: false,
      currentTimeFn: () => audioElement.currentTime,
      playAudioFn: () => audioElement.play(),
      pauseAudioFn: () => audioElement.pause()
    };
  }
  /** Update global footer controls */
  function updateFooter(audio, playBtn, idx) {
    if(audio || playBtn) {
      let paused = true;
      if(audio) paused = audio.paused;
      else if(playBtn) paused = playBtn.innerHTML === playSVG;
      footerPlayBtn.innerHTML = paused ? playSVG : pauseSVG;
      footerPlayBtn.disabled = false;
      footerPlayBtn._linkedAudio = audio;
      footerPlayBtn._linkedPlayBtn = playBtn;
      footerPlayBtn._linkedIndex = idx;
      if(audio) footerVolumeInput.value = audio.volume;
      updateVolumeBar(audio? audio.volume : 1);
    } else {
      footerPlayBtn.innerHTML = playSVG;
      footerPlayBtn.disabled = true;
      footerPlayBtn._linkedAudio = null;
      footerPlayBtn._linkedPlayBtn = null;
      footerPlayBtn._linkedIndex = -1;
      updateVolumeBar(1);
    }
  }
  function updateFooterTime(_cur) {} // reserved, no implementation yet

  // Update volume input background fill using CSS variable
  function updateVolumeBar(volume) {
    const perc = Math.round(volume * 100);
    footerVolumeInput.style.setProperty('--vol-percent', perc + '%');
  }

  /* Global footer play/pause */
  footerPlayBtn.addEventListener('click', () => {
    const audio = footerPlayBtn._linkedAudio;
    const playBtn = footerPlayBtn._linkedPlayBtn;
    if(!audio) return;
    if(audio.paused) {
      tracks.forEach(({audio: a, btnPlay: b}) => {
        if(a !== audio && a) {
          a.pause();
          b.innerHTML = playSVG;
        }
      });
      audio.play();
      playBtn.innerHTML = pauseSVG;
      footerPlayBtn.innerHTML = pauseSVG;
    } else {
      audio.pause();
      playBtn.innerHTML = playSVG;
      footerPlayBtn.innerHTML = playSVG;
    }
  });

  /* Global volume update */
  footerVolumeInput.addEventListener('input', e => {
    const vol = parseFloat(e.target.value);
    tracks.forEach(({audio}) => {
      if(audio) audio.volume = vol;
    });
    updateVolumeBar(vol);
  });

  /* Play next track for seamless playback */
  function playNextTrack(currentIndex) {
    let nextIdx = currentIndex + 1;
    if(nextIdx >= tracks.length) {
      updateFooter(null, null, -1);
      return;
    }
    const {audio, btnPlay, container} = tracks[nextIdx];
    // Pause all except next
    tracks.forEach(({audio: a, btnPlay: b}) => {
      if(a && a !== audio) {
        a.pause();
        b.innerHTML = playSVG;
      }
    });
    audio.currentTime = 0;
    audio.play();
    btnPlay.innerHTML = pauseSVG;
    playingIndex = nextIdx;
    updateFooter(audio, btnPlay, nextIdx);
    // Scroll track into vertical center view if not visible
    const bounding = container.getBoundingClientRect();
    const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
    const isFullyVisible = bounding.top >= 0 && bounding.bottom <= viewportHeight;
    if(!isFullyVisible) {
      // scroll so the element is vertically centered fast but smooth
      const scrollToY = window.scrollY + bounding.top - (viewportHeight / 2) + (bounding.height / 2);
      window.scrollTo({
        top: scrollToY,
        behavior: 'smooth'
      });
    }
  }

  // Handle keyboard skip time and volume control by mouse wheel on volume slider
  window.addEventListener('keydown', (e) => {
    // Only apply if a track is playing
    if (playingIndex === -1) return;

    const currentAudio = tracks[playingIndex].audio;
    if (!currentAudio) return;

    const skipSmall = 10; // seconds for cursor alone
    const skipLarge = 60; // seconds for cursor+ctrl

    if (e.code === 'ArrowRight' || e.code === 'ArrowLeft') {
      e.preventDefault();
      const direction = e.code === 'ArrowRight' ? 1 : -1;
      const skipAmount = e.ctrlKey ? skipLarge : skipSmall;
      let newTime = currentAudio.currentTime + direction * skipAmount;
      if (newTime < 0) newTime = 0;
      if (currentAudio.duration && newTime > currentAudio.duration) newTime = currentAudio.duration;
      currentAudio.currentTime = newTime;
    }
  });

  // Volume control by mouse wheel over the global volume control slider
  footerVolumeInput.addEventListener('wheel', (e) => {
    e.preventDefault();
    const delta = e.deltaY || e.detail || e.wheelDelta;
    const step = 0.05;
    let vol = parseFloat(footerVolumeInput.value);
    if (delta < 0) {
      vol += step;
    } else {
      vol -= step;
    }
    vol = Math.min(1, Math.max(0, vol));
    footerVolumeInput.value = vol;
    tracks.forEach(({audio}) => {
      if (audio) audio.volume = vol;
    });
    updateVolumeBar(vol);
  }, { passive: false });

  // Init UI and playback
  const playlistRoot = document.getElementById('playlist-container');
  musicData.forEach((trackData, i) => {
    const trackObj = createTrackElement(trackData, i);
    tracks.push(trackObj);
    playlistRoot.appendChild(trackObj.container);
  });
  // Set initial footer button icon to play
  footerPlayBtn.innerHTML = playSVG;
  updateVolumeBar(1);
  // Pause all on unload
  window.addEventListener('pagehide', () => {
    tracks.forEach(({audio}) => {
      if(audio) audio.pause();
    });
  });
</script>
</body>
</html>
